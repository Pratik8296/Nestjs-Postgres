# Nestjs-Postgres
Demo project: NestJS + Prisma + PostgreSQL

This repository is a minimal NestJS application demonstrating integration with Prisma (generated client) and PostgreSQL. It's configured to build to `dist/` and includes a generated Prisma client located under `src/generated/prisma` that the app expects at runtime.

**What this project contains**
- NestJS app scaffold (controllers, services, modules) in `src/`.
- A Prisma schema in `prisma/schema.prisma` and generated client files under `src/generated/prisma`.
- A small `PrismaService` (in `src/database/database.service.ts`) that extends the generated Prisma client and is used by other services (e.g. `users`).

**Notes about the runtime setup**
- The compiled code expects the generated Prisma client to be present under `dist/generated/prisma` when running production builds. During development you typically run the app with `nest start` or `npm run start:dev` which uses the TypeScript source.
- Environment variables (notably `DATABASE_URL`) are required. The app includes `dotenv` loading in the bootstrap so add a `.env` file at the repository root.

Example `.env`:

```
DATABASE_URL="postgresql://username:password@host:5432/dbname?schema=public"
# If your provider requires skipping cert validation (not recommended except for local testing):
# DB_SSL=true
```

**Build & Run (local)**

- Install dependencies:

```bash
npm install
```

- Build the project:

```bash
npm run build
```

- Run production build:

```bash
npm run start:prod
```

- Run in development (watch / HMR via Nest CLI):

```bash
npm run start:dev
```

**Prisma commands (useful run commands and workflow)**

Note: adjust commands if you use `npx` or global `prisma` install. The commands below assume you run them from the repository root.

- Format / validate schema (optional):

```bash
npx prisma format
npx prisma validate
```

- Generate the Prisma client (writes to `node_modules/@prisma/client` and updates generated client code):

```bash
npx prisma generate
```

- Migrate database (create migration and apply locally):

```bash
# Create a new migration from schema changes
npx prisma migrate dev --name "migration_name"

# Apply pending migrations (useful in CI / production)
npx prisma migrate deploy
```

- Inspect the database and open Studio (web GUI):

```bash
npx prisma studio
```

- Reset local dev database (WARNING: destructive):

```bash
npx prisma migrate reset
```

- Generate TypeScript types (if not already generated by `prisma generate`):

```bash
npx prisma generate --schema=prisma/schema.prisma
```

**Debugging Prisma / DB connectivity**

- Verify the `DATABASE_URL` is set and reachable. Quick tests:

```bash
# Using node + pg module
node -e "(async ()=>{const { Pool }=require('pg'); const pool=new Pool({connectionString: process.env.DATABASE_URL}); const r=await pool.query('SELECT NOW()'); console.log(r.rows[0]); await pool.end();})().catch(e=>console.error(e))"

# Enable adapter debug logs when debugging adapter connectivity
# Windows (cmd.exe):
set DEBUG=prisma:driver-adapter:pg
node scripts/test-prisma-create.js

# PowerShell:
$env:DEBUG='prisma:driver-adapter:pg'; node scripts/test-prisma-create.js
```

**Troubleshooting tips**
- If your application throws `ECONNREFUSED` from Prisma while a raw `pg` connection works, ensure the Prisma adapter is constructed with the same `DATABASE_URL` and SSL options. In this repo `src/database/database.service.ts` was updated to pass `connectionString: process.env.DATABASE_URL` into the adapter.
- Ensure `.env` is loaded before the Prisma adapter is constructed (import `dotenv/config` early in bootstrap).
- For TLS/SSL errors, you may need to pass `ssl: { rejectUnauthorized: false }` for local testing (not recommended in production).

If you'd like, I can add short scripts to `package.json` to standardize these Prisma commands for your environment. Would you like that?
